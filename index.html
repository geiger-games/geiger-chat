<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeigerChat</title>
    <style>
        #chatbar { position: fixed; left: 40%; top: 80%; width: 40%; height: 10%; transform: translate(-50%, -50%); }
        #enterbtn { position: fixed; left: 70%; top: 80%; width: 20%; height: 10%; transform: translate(-50%, -50%); }
        #msgs { display: flex; flex-direction: column; max-width: 80%; margin: 2em auto; gap: 0.3em; }
        #changeUsername { position: fixed; left: 90%; top: 0%; width: 10%; height: 10%; }
        .msg { padding: 0.5em 1em; border-radius: 12px; background-color: #f1f1f1; max-width: 70%; word-wrap: break-word; transition: transform 0.2s ease, background-color 0.2s ease; }
        .msg.your { background-color: blueviolet; }
    </style>
</head>
<body>
    <div id="msgs"></div>
    <input type="text" id="chatbar" placeholder="Chat here!" maxlength="150">
    <button id="enterbtn">Enter</button>
    <button id="changeUsername">Change username</button>

    <script>
    const bannedWords = ["btt","ojhhb","ojhhfs","gvdl","tiju","cjudi","gvdlbtt","bttipmf","jejpu","bttgvdl","cvuugvdl"];
    const chatBar = document.getElementById("chatbar");
    const enterBtn = document.getElementById("enterbtn");
    const content = document.getElementById("msgs");
    const changeUsernameButton = document.getElementById("changeUsername");
    let username;

    function changeUsername(override) {
        username = override ? null : localStorage.getItem("username");
        if (!username) {
            while (!username || username.length < 4) {
                username = prompt("username (4+ characters): ")?.trim() || "";
            }
            username = `${username}#${Math.floor(Math.random() * 10000)}`;
            localStorage.setItem("username", username);
        }
    }

    window.onload = function(){
        changeUsername(false);
    };

    function decode(str){ return str.split('').map(c=>String.fromCharCode(c.charCodeAt(0)-1)).join(''); }
    function normalizeText(str){ return str.normalize("NFD").replace(/[\u0300-\u036f]/g,""); }

    // Escape HTML but allow basic tags
    function sanitize(text){
        let escaped = text.replace(/&/g,"&amp;")
                          .replace(/</g,"&lt;")
                          .replace(/>/g,"&gt;");
        return escaped;
    }

    function markdown(text){
        let newText = text.replace(/\*\*(.+?)\*\*/gi, "<b>$1</b>");
        newText = newText.replace(/\*(.+?)\*/gi, "<i>$1</i>");
        ["red", "orange", "yellow", "green", "blue", "purple"].forEach(color => {
            newText = newText.replace(new RegExp(`&lt;${color}&gt;(.+?)&lt;/${color}&gt;`, "gi"), `<p style="color: ${color};">$1</p>`);
        });
        return newText;
    }

    function cleanText(text){
        let cleaned = markdown(sanitize(normalizeText(text)));
        bannedWords.forEach(word => {
            cleaned = cleaned.replace(new RegExp(`\\b${decode(word)}\\b`,"gi"), "[expletive]");
        });
        return cleaned;
    }

    let canPost = true; // slowmode flag

    (async()=>{
        async function getMessages(){
            try{
                const res = await fetch("https://getpantry.cloud/apiv1/pantry/60a648db-d0da-463b-93f6-627dde4d4a73/basket/messages");
                if(!res.ok) throw new Error(res.status);
                const d = await res.json();
                const data = d["_"] || [];
                content.innerHTML = "";
                data.forEach(msgText=>{
                    const div = document.createElement("div");
                    div.classList.add("msg");
                    if (msgText.startsWith(username)) {
                        div.classList.add("your");
                        div.innerHTML = msgText.replace(username, `You (${username})`);
                    } else {
                        div.innerHTML = msgText;
                    }
                    content.appendChild(div);
                });
                content.scrollTop = content.scrollHeight;
            }catch(e){ console.error("Fetch error:", e); }
        }

        getMessages();

        enterBtn.addEventListener("click", async()=>{
            if(!canPost){ alert("Slowmode active! Go touch some grass."); return; }
            let msg = chatBar.value.trim();
            if(!msg) return;
            msg = `${username}: ${cleanText(msg)}`;

            try{
                // fetch current messages
                const res = await fetch("https://getpantry.cloud/apiv1/pantry/60a648db-d0da-463b-93f6-627dde4d4a73/basket/messages");
                const d = await res.json();
                let data = d["_"] || [];
                data.push(msg);
                // post new message
                await fetch("https://getpantry.cloud/apiv1/pantry/60a648db-d0da-463b-93f6-627dde4d4a73/basket/messages", {
                    method:"POST",
                    headers:{"Content-Type":"application/json"},
                    body:JSON.stringify({"_":data})
                });
                // update UI immediately
                const div = document.createElement("div");
                div.classList.add("msg");
                if (msg.startsWith(username)) {
                div.innerHTML = msg.replace(username, `You (${username})`);
                div.classList.add("your");
                content.appendChild(div);
                content.scrollTop = content.scrollHeight;
                chatBar.value = "";

                // slowmode
                canPost = false;
                const delay = Math.floor(Math.random()*5000)+5000; // 5-10 sec
                setTimeout(()=>{ canPost=true; }, delay);

            }} catch(e){ console.error("Post error:", e); }
        });

        changeUsernameButton.addEventListener("click", _=>{
            changeUsername(true);
        });
    })();
    </script>
</body>
</html>